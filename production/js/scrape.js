const puppeteer=require("puppeteer"),onet=require("./onet"),helpers=require("./helpers"),setup=require("./routing_setup");let routObj=setup.routingSetUp(),port=routObj.port,app=routObj.app,scrape=async()=>{const e=await puppeteer.launch({headless:!0}),t=await e.newPage();await t.goto(onet.url);let n=await t.evaluate(onet.text),i=await t.evaluate(onet.link);onet.shortenMe(n),i=onet.trimMe(i),onet.shortenMe(i);let r=helpers.combineObj(n,i);return e.close(),{json:r,title:n,links:i,time:new Date}},scrapeLink=async e=>{const t=await puppeteer.launch({headless:!0}),n=await t.newPage();await n.goto(e);let i=[];i=await t.newPage(),await i.goto(e);let r=await i.evaluate(()=>{return document.querySelector("#lead").innerText}),a=await i.evaluate(onet.article);a.pop(),a.unshift(r);let l=helpers.objectifyArticle(a);return t.close(),l};app.get("/",(e,t)=>{scrape().then(function(e){t.render("home",{name:"",displayData:e.json,acquired:helpers.formatDate(e)})})}),app.get("/link",(e,t)=>{let n=e.query.link;scrapeLink(n).then(function(e){t.send(e)})}),app.listen(port,e=>{if(e)return console.log("something bad happened",e);console.log(`server is listening on ${port}`)}),module.exports={combineObj:function(...e){function t(e,t){this.title=e,this.link=t}let n=[],i={};for(let i=0;i<e[1].length;i++){let r=new t(e[0][i],e[1][i]);n.push(r)}return i.newsFeed=n,i},objectifyArticle:function(e){let t=[],n={};for(let n=0;n<e.length;n++){let i={article:e[n]};t.push(i)}return n.articleEntry=t,JSON.stringify(n)},formatDate:function(e){let t=e.time.getMonth()+1;t=("0"+t.toString()).slice(-2);let n=("0"+e.time.getDate().toString()).slice(-2),i=("0"+e.time.getHours().toString()).slice(-2),r=("0"+e.time.getMinutes().toString()).slice(-2);return`${n}.${t}.${e.time.getFullYear()}  ${i}:${r}`}},module.exports={url:"https://www.onet.pl",text:()=>[...document.querySelectorAll("#mainPageBody > div.container-content-right.sideBar.sideBar2 > div:nth-child(1) > article > section:nth-child(1) > div.boxContent > ul >li")].map(e=>e.innerText.replace(/\n|TYLKO W ONECIE|PILNE|NA Å»YWO|'/g,"").trim()),link:()=>[...document.querySelectorAll("#mainPageBody > div.container-content-right.sideBar.sideBar2 > div:nth-child(1) > article > section:nth-child(1) > div.boxContent > ul >li")].map(e=>e.innerHTML.replace(/"|'|class=*|/g,"")),article:()=>[...document.querySelectorAll("#detail > .hyphenate")].map(e=>e.innerText),trimMe:e=>{let t=[];for(let n of e){let e=n.indexOf("http"),i=n.indexOf("data",-1);t.push(n.slice(e,i).trim())}return t},shortenMe:e=>{let t=e.indexOf("''");-1!==t&&e[t].length<4&&e.splice(t,1),e.length>16&&(e.length=16)}};const path=require("path"),express=require("express"),exphbs=require("express-handlebars");exports.routingSetUp=(()=>{const e=express();return e.engine(".hbs",exphbs({defaultLayout:"main",extname:".hbs",layoutsDir:path.join(__dirname,"../views/layouts")})),e.set("view engine",".hbs"),e.set("views",path.join(__dirname,"../views")),e.use(express.static("../public")),{port:3e3,app:e}});